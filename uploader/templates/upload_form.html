{% extends "base.html" %}
{% from "macros.html" import form_field, textarea_field, file_field %}
{% from "websocket_uploader.html" import file_field_ws, websocket_upload_script %}

{% block title %}Create New Experiment - Experiment Server{% endblock %}

{% block page_title %}Experiment Upload{% endblock %}

{% block content %}
    <form action="/upload" enctype="multipart/form-data" method="post" id="uploadForm" onsubmit="return handleSubmit(event)">
        {{ form_field("experiment_name", "Experiment Name", required=true, placeholder="e.g., 2024_09_05-CTRL") }}
        
        <div class="form-row">
            {{ form_field("start_time", "Start Time", type="datetime-local", required=true) }}
            {{ form_field("end_time", "End Time", type="datetime-local") }}
        </div>
        
        <div class="form-row">
            {{ form_field("cell_type", "Cell Type", required=true, placeholder="e.g., E.coli, HeLa") }}
            {{ form_field("condition", "Condition", placeholder="e.g., CTRL, Treatment") }}
        </div>
        
        <div class="form-row">
            {{ form_field("condition_amount", "Condition Amount", type="number", placeholder="e.g., 100") }}
            {{ form_field("condition_unit", "Condition Unit", placeholder="e.g., μM, mg/mL") }}
        </div>
        
        {{ form_field("condition_time", "Condition Time", type="datetime-local") }}
        
        {{ textarea_field("notes", "Notes", placeholder="Additional experiment notes (optional)") }}
        
        {{ file_field("experiment_files", "Upload Experiment Data", required=true, multiple=true) }}
        
        {{ file_field("ac_images", "Upload AC images (Optional)", multiple=true) }}
        
        {{ file_field("dc_images", "Upload DC images (Optional)", multiple=true) }}
        
        {{ file_field("seg_images", "Upload segmentation images (Optional)", multiple=true) }}
        
        {{ file_field_ws("raw_images", "Upload raw images (Optional)", help_text="Select folders containing raw images (TIF, PNG, JPG). Only folders with image files will be included, and directory structure will be preserved.") }}
        
        <!-- Hidden input for WebSocket upload paths -->
        <input type="hidden" id="raw_image_paths" name="raw_image_paths" value="">
        <input type="hidden" id="websocket_upload_completed" name="websocket_upload_completed" value="false">
        
        <input type="submit" value="Upload Experiment" id="uploadButton">
    </form>
    
    <p class="info-text">Files will be processed and saved to the experiment database</p>
{% endblock %}

{% block scripts %}
    {{ super() }}
    {{ websocket_upload_script(upload_endpoint="/ws/upload",
                               upload_button_id="uploadButton",
                               progress_container_id="progressContainer",
                               status_messages_id="statusMessages",
                               directory_input_id="directoryInput",
                               experiment_name_input_id="experiment_name") }}
    <script>
        // Dynamic required fields logic for condition-related inputs
        const conditionInput = document.getElementById('condition');
        const conditionAmount = document.getElementById('condition_amount');
        const conditionUnit = document.getElementById('condition_unit');
        const conditionTime = document.getElementById('condition_time');
        const startTime = document.getElementById('start_time');
        const endTime = document.getElementById('end_time');
        const ACImagesInput = document.getElementById('ac_images');
        const DCImagesInput = document.getElementById('dc_images');
        const segImagesInput = document.getElementById('seg_images');

        function updateConditionFields() {
            const hasCondition = !['', 'None', 'N/A', 'NA', 'null', 'Null', 'NULL','CTRL'].includes(conditionInput.value.trim());
            
            conditionAmount.required = hasCondition;
            conditionUnit.required = hasCondition;
            conditionTime.required = hasCondition;
            
            // Update visual indicators
            const amountLabel = document.querySelector('label[for="condition_amount"]');
            const unitLabel = document.querySelector('label[for="condition_unit"]');
            const timeLabel = document.querySelector('label[for="condition_time"]');
            
            if (hasCondition) {
                amountLabel.classList.add('required');
                unitLabel.classList.add('required');
                timeLabel.classList.add('required');
            } else {
                amountLabel.classList.remove('required');
                unitLabel.classList.remove('required');
                timeLabel.classList.remove('required');
            }
        }
        
        function validateDates() {
            const start = new Date(startTime.value);
            const end = new Date(endTime.value);
            const condition = new Date(conditionTime.value);
            
            // End time cannot be before start time
            if (endTime.value && startTime.value && end < start) {
                endTime.setCustomValidity('End time cannot be before start time');
            } else {
                endTime.setCustomValidity('');
            }
            
            // Condition time must be between start and end time
            if (conditionTime.value && startTime.value) {
                if (condition < start) {
                    conditionTime.setCustomValidity('Condition time cannot be before start time');
                } else if (endTime.value && condition > end) {
                    conditionTime.setCustomValidity('Condition time cannot be after end time');
                } else {
                    conditionTime.setCustomValidity('');
                }
            } else {
                conditionTime.setCustomValidity('');
            }
        }

        // Validation for image file inputs
        function validateImageFiles(input, filter_string = null) {
            input.addEventListener('change', function() {
                const files = Array.from(this.files);
                const validFiles = files.filter(file => {
                    const ext = file.name.split('.').pop().toLowerCase();
                    const isImage = ['tif', 'tiff', 'png', 'jpg', 'jpeg'].includes(ext);
                    const hasFilter = !filter_string || file.name.toLowerCase().includes(filter_string.toLowerCase());
                    return isImage && hasFilter;
                });
                
                if (validFiles.length === 0 && files.length > 0) {
                    alert(`Please select valid image files${filter_string ? ` containing "${filter_string}"` : ''}`);
                    this.value = '';
                }
            });
        }
        
        // Apply validation to all image inputs
        validateImageFiles(ACImagesInput, 'ac');
        validateImageFiles(DCImagesInput,'dc');
        validateImageFiles(segImagesInput,'seg');
        
        // Test WebSocket connection function
        function testWebSocketConnection() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const testId = 'test_' + Math.random().toString(36).substr(2, 9);
            const testUrl = `${protocol}//${window.location.host}/ws/upload/${testId}?upload_name=test`;
            
            console.log('Testing WebSocket connection to:', testUrl);
            
            const testSocket = new WebSocket(testUrl);
            
            testSocket.onopen = function() {
                console.log('✅ WebSocket test connection successful');
                testSocket.close();
            };
            
            testSocket.onerror = function(error) {
                console.error('❌ WebSocket test connection failed:', error);
            };
            
            testSocket.onclose = function(event) {
                console.log('WebSocket test connection closed:', event.code, event.reason);
            };
        }

        // Call this on page load to test connectivity
        document.addEventListener('DOMContentLoaded', function() {
            testWebSocketConnection();
        });
        function handleSubmit(event) {
            console.log('Form submission started');
            
            // Validate all fields first
            validateDates();
            updateConditionFields();
            
            // Check if any fields have validation errors
            const invalidFields = document.getElementById('uploadForm').querySelectorAll(':invalid');
            if (invalidFields.length > 0) {
                console.log('Form validation failed', invalidFields);
                event.preventDefault();
                invalidFields[0].focus();
                return false;
            }
            
            console.log('Form validation passed, submitting');
            return true;
        }

        // Event listeners
        conditionInput.addEventListener('input', updateConditionFields);
        startTime.addEventListener('change', validateDates);
        endTime.addEventListener('change', validateDates);
        conditionTime.addEventListener('change', validateDates);
        
        // Initialize on page load
        updateConditionFields();
    </script>
{% endblock %}